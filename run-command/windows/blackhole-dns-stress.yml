description: >-
  # Blackhole DNS Stress

  Block DNS on a windows instance. 

schemaVersion: "2.2"
parameters:
  duration:
    type: String
    description: The duration - in seconds - of the attack. (Required)
    default: "60"
mainSteps:
  - name: RevertCommandScheduling
    action: 'aws:runPowerShellScript'
    inputs:
      runCommand:
        - |
          $name = "chaosjob"
          $action = @"
            Remove-NetFirewallRule -DisplayName "CHAOS Block DNS IP address"
            UnRegister-ScheduledJob -Name $name -Force
          "@
          $scriptBlock = [Scriptblock]::Create($action)
          $trigger = New-JobTrigger -Once -At (Get-Date).AddSeconds({{duration}} )
          $opts = New-ScheduledJobOption -RunElevated
          Register-ScheduledJob -Name $name -ScriptBlock $scriptBlock -Trigger $trigger -ScheduledJobOption $opts
  - name: AlterDNS
    action: "aws:runPowerShellScript"
    inputs:
      runCommand:
        - |
          $addresses = Get-DnsClientServerAddress -AddressFamily "IPv4" | select -ExpandProperty ServerAddresses 
          New-NetFirewallRule -DisplayName "CHAOS Block DNS IP address" -Direction Outbound –LocalPort Any -Protocol UDP -Action Block -RemoteAddress $addresses
          New-NetFirewallRule -DisplayName "CHAOS Block DNS IP address" -Direction Outbound –LocalPort Any -Protocol TCP -Action Block -RemoteAddress $addresses
  - name: RunTestFail
    action: "aws:runPowerShellScript"
    inputs:
      runCommand:
        - | 
          Resolve-DnsName -Name www.amazon.com -DnsOnly
  - name: RunTestPass
    action: "aws:runPowerShellScript"
    inputs:
      runCommand:
        - |
          Start-Sleep -s {{duration}} 
          Start-Sleep -s 10
          Resolve-DnsName -Name www.amazon.com -DnsOnly