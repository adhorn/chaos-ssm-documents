description: >-
  # Blackhole DynamoDB Stress

  Block Dynamo on a windows instance. 

schemaVersion: "2.2"
parameters:
  duration:
    type: String
    description: The duration - in seconds - of the attack. (Required)
    default: "60"
  regions:
    type: String
    description: The regions you would like to block (Required)
    default: "us-east-1,us-west-1,eu-west-1,eu-west-2"
mainSteps:
  - name: AlterFirewall
    action: "aws:runPowerShellScript"
    inputs:
      runCommand:
        - |
          $regions = "{{regions}}".Split(",")
          $addresses = New-Object Collections.Generic.List[String]
          foreach ($region in $regions) {
          $addresses.Add("dynamodb.$($region).amazonaws.com")
          }
          foreach ($address in $addresses) {
          $addressips = Resolve-DnsName -Name $address -Type A -DnsOnly
          foreach($addressip in $addressips.IPAddress){          
          New-NetFirewallRule -DisplayName "CHAOS Block Dynamo IP address" -Direction Outbound –LocalPort Any -Protocol UDP -Action Block -RemoteAddress $addressip | Out-Null
          Write-Host "Added $($addressip) for $($address) to the Firewall and Blocked for UDP"
          New-NetFirewallRule -DisplayName "CHAOS Block Dynamo IP address" -Direction Outbound –LocalPort Any -Protocol TCP -Action Block -RemoteAddress $addressip | Out-Null
          Write-Host "Added $($addressip) for $($address) to the Firewall and Blocked for TCP"
          }
          }
  - name: Pause
    action: 'aws:runPowerShellScript'
    inputs:
      runCommand:
        - "Start-Sleep -s {{duration}}"
  - name: Revert
    action: 'aws:runPowerShellScript'
    inputs:
      runCommand:
        - Remove-NetFirewallRule -DisplayName "CHAOS Block Dynamo IP address"