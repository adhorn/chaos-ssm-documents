---
description: |
  ## What does this document do?
  It runs memory stress on an instance via stress-ng tool.

  ## Input Parameters
  * Duration: The duration - in seconds - of the memory stress (default: 60).
  * Workers: The number of virtual memory stressors (default: 1).
  * Percent: The percentage of virtual memory to use (required).
  * InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).

  ## Output Parameters
  None.

schemaVersion: '2.2'
parameters:
  Duration:
    type: String
    description: "The duration - in seconds - of the memory stress (default: 60)."
    default: "60"
    allowedPattern: "^[0-9]+$"
  Workers:
    type: String
    description: "The number of virtual memory stressors (default: 1)."
    default: "1"
    allowedPattern: "^[0-9]+$"
  Percent:
    type: String
    description: "The percentage of virtual memory to use (required)."
    allowedPattern: "^[0-9]+$"
  InstallDependencies:
    type: String
    description: "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True)."
    default: 'True'
    allowedValues:
      - 'True'
      - 'False'
mainSteps:
  - action: aws:runShellScript
    precondition:
      StringEquals:
        - platformType
        - Linux
    name: InstallDependencies
    description: |
      ## Parameter: InstallDependencies
      If set to True, this step installs the required dependency via operating system's repository. It supports both
      Debian (apt) and CentOS (yum) based package managers.
    inputs:
      runCommand:
        - |
          #!/bin/bash
          if  [[ "{{ InstallDependencies }}" == True ]] ; then
            echo "Installing required dependencies"
            if [ -f  "/etc/system-release" ] ; then
              if cat /etc/system-release | grep -i 'Amazon Linux' ; then
                sudo amazon-linux-extras install testing
                sudo yum -y install stress-ng
              else
                echo "There was a problem installing dependencies."
                exit 1
              fi
            elif cat /etc/issue | grep -i Ubuntu ; then
              sudo apt-get update -y
              sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng
            else
              echo "There was a problem installing dependencies."
              exit 1
            fi
          fi
  - action: aws:runShellScript
    precondition:
      StringEquals:
        - platformType
        - Linux
    name: ExecuteStressNg
    description: |
      ## Parameters: Duration, Workers and Percent
      This step will run a memory stress test on the instance for the specified Duration time - in seconds.
      It will start `Workers` number of workers, using `Percent` of the total available memory.
    inputs:
      maxAttempts: 1
      runCommand:
        - |
          if [ {{ Duration }} -lt 1 ] || [ {{ Duration }} -gt 43200 ] ; then echo Duration parameter value must be between 1 and 43200 seconds && exit; fi
          pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit
          echo Initiating memory stress for {{ Duration }} seconds, {{ Workers }} workers, using {{ Percent }} of total available memory...
          stress-ng --vm {{ Workers }} --vm-bytes {{ Percent }}% -t {{ Duration }}s
          echo Finished memory stress.